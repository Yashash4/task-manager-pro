<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Task Manager Pro</title>
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-dot"></span> Task Manager Pro
            </div>
            <div class="nav-links">
                <span class="text-secondary" id="userName">User</span>
                <button class="btn btn-secondary btn-sm" data-logout>Logout</button>
            </div>
        </div>
    </nav>

    <div class="wrapper">
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="dashboard.html">ðŸ“Š Dashboard</a></li>
                <li><a href="tasks.html">âœ… My Tasks</a></li>
                <li><a href="notifications.html">ðŸ”” Notifications</a></li>
                <li><a href="profile.html" class="active">ðŸ‘¤ Profile</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Profile Information</h2>
                    </div>
                    <div class="card-body">
                        <form id="profileForm">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" id="profileUsername" disabled>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="profileEmail" disabled>
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <input type="text" id="profileRole" disabled>
                            </div>
                            <div class="form-group">
                                <label>Member Since</label>
                                <input type="text" id="profileJoined" disabled>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Security</h2>
                    </div>
                    <div class="card-body">
                        <form id="passwordForm">
                            <div class="form-group">
                                <label>Current Password</label>
                                <input type="password" id="currentPassword" placeholder="Enter current password" required>
                            </div>
                            <div class="form-group">
                                <label>New Password</label>
                                <input type="password" id="newPassword" placeholder="Enter new password" required>
                                <small class="password-hint">Password strength: <span id="pwdStrength">Weak</span></small>
                            </div>
                            <div class="form-group">
                                <label>Confirm Password</label>
                                <input type="password" id="confirmPassword" placeholder="Confirm new password" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Change Password</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.0/dist/umd/supabase.min.js"></script>
    <script src="../assets/js/core/supabaseClient.js"></script>
    <script src="../assets/js/core/utils.js"></script>
    <script src="../assets/js/core/validation.js"></script>
    <script src="../assets/js/core/auth.js"></script>
    <script>
        (async function () {
          const supabase = window.SUPABASE?.client?.();
          let currentProfile = null;

          async function init() {
            const user = await API.getCurrentUser();
            if (!user) {
              window.location.href = '/auth/login.html';
              return;
            }

            currentProfile = await API.getUserProfile(user.id);
            if (!currentProfile) {
              await supabase.auth.signOut();
              window.location.href = '/auth/login.html';
              return;
            }

            DOM.setText(DOM.id('userName'), currentProfile.username);
            loadProfile();
            setupPasswordForm();
          }

          function loadProfile() {
            DOM.id('profileUsername').value = currentProfile.username;
            DOM.id('profileEmail').value = currentProfile.email;
            DOM.id('profileRole').value = currentProfile.role_flags?.[0] || 'user';
            DOM.id('profileJoined').value = TimeHelper.formatDate(currentProfile.joined_at);
          }

          function setupPasswordForm() {
            const form = DOM.id('passwordForm');
            const newPwdInput = DOM.id('newPassword');
            const pwdStrengthSpan = DOM.id('pwdStrength');

            DOM.on(newPwdInput, 'input', () => {
              const strength = PasswordStrength.calculate(newPwdInput.value);
              pwdStrengthSpan.textContent = strength.level;
              pwdStrengthSpan.style.color = strength.color;
            });

            DOM.on(form, 'submit', async (e) => {
              e.preventDefault();

              const currentPassword = DOM.id('currentPassword').value;
              const newPassword = DOM.id('newPassword').value;
              const confirmPassword = DOM.id('confirmPassword').value;

              if (newPassword !== confirmPassword) {
                Toast.error('New passwords do not match');
                return;
              }

              const error = FormValidator.validatePassword(newPassword);
              if (error) {
                Toast.error(error);
                return;
              }

              try {
                // Supabase requires re-authentication to change password, but for simplicity
                // we will directly try to update it. Note: This requires a specific setup.
                // The most secure way is to reauthenticate first.
                // For now, we update the user attribute.
                const { error: updateErr } = await supabase.auth.updateUser({
                  password: newPassword
                });

                if (updateErr) throw updateErr;

                Toast.success('Password changed successfully!');
                form.reset();
                pwdStrengthSpan.textContent = 'Weak';
                pwdStrengthSpan.style.color = '';

              } catch (err) {
                console.error('Password change error:', err);
                Toast.error(err.message || 'Failed to change password. Your current password may be incorrect.');
              }
            });
          }

          document.addEventListener('DOMContentLoaded', init);
        })();
    </script>
</body>
</html>